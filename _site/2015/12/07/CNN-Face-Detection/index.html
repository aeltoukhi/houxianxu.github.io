<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CNN Face Dectection</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="From Coal Mining to Data Mining">
    <link rel="canonical" href="http://houxianxu.github.io/2015/12/07/CNN-Face-Detection/">
    <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Xianxu Hou's blog posts" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-61586501-1', 'auto');
      ga('send', 'pageview');
    </script>

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <div style="float:left; margin-top:10px; margin-right:10px;">
      <img src="/assets/avatar_Xianxu Hou.png" width="40">
    </a>
    </div>

    <a class="site-title" href="/">Xianxu Hou's blog</a>
    
    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          
        
          
        
      </div>
    </nav>
  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>CNN Face Dectection</h1>
    <p class="meta">Dec 7, 2015</p>
  </header>

  <article class="post-content">
  <p>The post records some notes for CNN Face Dectection project in my PhD in the University of Nottingham.</p>

<h3 id="note-1-make-image-square-and-cropsplit-it-into-subimages">Note 1: Make image square and crop/split it into sub_images</h3>
<p><strong>Make image square</strong></p>

<p>In order to use Convolutional Neural Network that (mostly) requires the input image square, i.e. of shape (3, N, N), I need to make the height equals to width. There are 3 ways coming into my mind:</p>

<ul>
  <li>Stretch the image to square, <strong>not good</strong> because the face could be stretched.</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">stretch_to_square</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>Crop the image to square, usually set the cropped size as the smaller one of width and height. <strong>Not good</strong> because information could be lost</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">crop_to_square</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">x_size</span> <span class="n">y_size</span><span class="p">:</span>
        <span class="c"># landscape</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_size</span> <span class="o">-</span> <span class="n">y_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">frame</span><span class="p">[:,</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">y_size</span><span class="p">,:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># portrait</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_size</span> <span class="o">-</span> <span class="n">x_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">frame</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">x_size</span><span class="p">,:,:]</span></code></pre></figure>

<ul>
  <li>Padded the image with zeros to square, <strong>better solution</strong>. However we need to store the padded size in order to convert from padded image coordinates to original image coordinates. We can define a new class SuperImage to achieve this.</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">padding_to_square</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">bookkeeping</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">up_scale</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">y_size</span> <span class="o">==</span> <span class="n">x_size</span><span class="p">:</span>
        <span class="n">padded_frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">super_image</span> <span class="o">=</span> <span class="n">SuperImage</span><span class="p">(</span><span class="n">padded_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_size</span> <span class="n">x_size</span><span class="p">:</span>
        <span class="n">pad_before</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_size</span> <span class="o">-</span> <span class="n">x_size</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pad_after</span> <span class="o">=</span> <span class="n">y_size</span> <span class="o">-</span> <span class="n">x_size</span> <span class="o">-</span> <span class="n">pad_before</span>
        <span class="n">padded_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s">'constant'</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">up_scale</span><span class="p">:</span>  <span class="c"># up scale the image, more padding if needed</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="n">y_size</span> <span class="o">//</span> <span class="n">up_scale</span>
            <span class="n">padded_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">padded_frame</span><span class="p">,</span> <span class="p">((</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s">'constant'</span><span class="p">)</span>
        <span class="n">super_image</span> <span class="o">=</span> <span class="n">SuperImage</span><span class="p">(</span><span class="n">padded_frame</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad_before</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_size</span> <span class="o">&lt;</span> <span class="n">x_size</span><span class="p">:</span>
        <span class="n">pad_before</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_size</span> <span class="o">-</span> <span class="n">y_size</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pad_after</span> <span class="o">=</span> <span class="n">x_size</span> <span class="o">-</span> <span class="n">y_size</span> <span class="o">-</span> <span class="n">pad_before</span>
        <span class="n">padded_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">((</span><span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s">'constant'</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">up_scale</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="n">x_size</span> <span class="o">//</span> <span class="n">up_scale</span>
            <span class="n">padded_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">padded_frame</span><span class="p">,</span> <span class="p">((</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s">'constant'</span><span class="p">)</span>
        <span class="n">super_image</span> <span class="o">=</span> <span class="n">SuperImage</span><span class="p">(</span><span class="n">padded_frame</span><span class="p">,</span> <span class="n">pad_before</span> <span class="o">+</span> <span class="n">pad</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bookkeeping</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">super_image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">padded_frame</span>

<span class="k">class</span> <span class="nc">SuperImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">""" Store the current position of a super_image (after padding) """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="s">"""
        - image: an array, represent the sub image
        - y: int to represent the top coordinate in the parent image
        - x: int to represent the left coordinate in the parent image
        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">type</span> <span class="o">=</span> <span class="s">'SuperImage'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sup_y0</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sup_x0</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">old_x_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="s">""" convert (y, x) in the super image to the parent / old image coordinate system """</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sup_y0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sup_x0</span><span class="p">)</span></code></pre></figure>

<p><strong>Split image into sub_images</strong></p>

<p>For simplicity (because simple is good), I use sliding window to split images. I design to overlap the sub_images to make sure any two continuous pixels can appear at least one sub_image. Specifically, if I want to get n*n sub_images, then set <code class="highlighter-rouge">stride = int(1.0/n * height)</code>, and sub_image size <code class="highlighter-rouge">sub_size = 2 * stride</code> to overlap half of the sub_images. If the size of remains are not enough to form a sub_image, we can add zero_padding or just throw them away.
In addition, we can use SubImage Class to store the information to convert sub_image coordinates back to original image.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">split_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">stride_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">pad_to_fit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s">""" split to n*n SubImages based on window sliding """</span>
    <span class="c"># make the image square</span>
    <span class="n">sub_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">square_image</span> <span class="o">=</span> <span class="n">padding_to_square</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">square_image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stride_ratio</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">sub_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stride</span>
    <span class="n">padding_image</span> <span class="o">=</span> <span class="n">square_image</span>
    <span class="k">if</span> <span class="n">pad_to_fit</span><span class="p">:</span>
        <span class="c"># decide how much padding need to make sure the sliding "fit" across input neatly</span>
        <span class="c"># it is like the zero_padding in the convolutional layer</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="n">stride</span>
        <span class="n">remain_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">stride</span>
        <span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">remain_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># need zero_padding, note: here should include 0 to make sure every image has the same number of sub images</span>
            <span class="n">pad_before</span> <span class="o">=</span> <span class="p">(</span><span class="n">stride</span> <span class="o">-</span> <span class="n">remain_size</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c"># may not be even</span>
            <span class="n">pad_after</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">-</span> <span class="n">remain_size</span> <span class="o">-</span> <span class="n">pad_before</span>
            <span class="n">padding_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">square_image</span><span class="p">,</span> <span class="p">((</span><span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span><span class="p">),</span> <span class="p">(</span><span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s">'constant'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">padding_image</span> <span class="o">=</span> <span class="n">square_image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">print</span> <span class="s">'pad'</span><span class="p">,</span> <span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span>
    <span class="n">pad_image_size</span> <span class="o">=</span> <span class="n">padding_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_image_size</span><span class="o">-</span><span class="n">stride</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span> 
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_image_size</span><span class="o">-</span><span class="n">stride</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">sub_size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pad_image_size</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">sub_size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pad_image_size</span><span class="p">:</span>  <span class="c"># not pad to fit </span>
                <span class="n">sub_image</span> <span class="o">=</span> <span class="n">padding_image</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">sub_size</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">sub_size</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c"># we need the original not the padded image in above when pad_to_fit</span>
                <span class="n">sub_image</span> <span class="o">=</span> <span class="n">SubImage</span><span class="p">(</span><span class="n">sub_image</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">pad_before</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">pad_before</span><span class="p">)</span>  <span class="c"># it is a little ugly, but it works</span>
                <span class="n">sub_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sub_images</span>

<span class="k">class</span> <span class="nc">SubImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">""" Store the current position of a sub_image """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="s">"""
        - image: an array, represent the sub image
        - y: int to represent the top coordinate in the parent image
        - x: int to represent the left coordinate in the parent image
        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">type</span> <span class="o">=</span> <span class="s">'SubImage'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sup_y0</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sup_x0</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">old_x_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="s">""" convert (y, x) in the subimage to the parent image coordinate system """</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sup_y0</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sup_x0</span><span class="p">)</span></code></pre></figure>

<p>** Convert from subimage to original image</p>

<p>The process is a little tricky. Because the subimages are actually cropped from padded image, the coordinates of subimages in the coordinate of original image can be less than 0, and also bigger than the original image size (see following figure). So we should make sure the details right when convert subimage information (e.g. human face bounding box) to original image coordinates.
<img src="http://houxianxu.github.io/images/CNNFace/1.png" alt="padded and subimage" title="padded and subimage" /></p>

<p>Following code illustrate how to convert a subimage heatmap to the corresponding position in the coordinates of the original image</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">pad_subheatmap_to_old_size</span><span class="p">(</span><span class="n">sub_heatmap_image</span><span class="p">,</span> <span class="n">sub_image</span><span class="p">,</span> <span class="n">padded_square</span><span class="p">):</span>
    <span class="s">""" Zero-pad sub_heatmap to the size of the old image size of which the sub_images cropped from """</span>
    <span class="n">padded_heatmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">padded_square</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">sub_image_size</span> <span class="o">=</span> <span class="n">sub_heatmap_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">padded_square_size</span> <span class="o">=</span> <span class="n">padded_square</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># get coordinate in old/super image of the origin point in the heatmap </span>
    <span class="n">y_start_old</span><span class="p">,</span> <span class="n">x_start_old</span> <span class="o">=</span> <span class="n">sub_image</span><span class="o">.</span><span class="n">old_x_y</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y_end_old</span><span class="p">,</span> <span class="n">x_end_old</span> <span class="o">=</span> <span class="n">y_start_old</span> <span class="o">+</span> <span class="n">sub_image_size</span><span class="p">,</span> <span class="n">x_start_old</span> <span class="o">+</span> <span class="n">sub_image_size</span>
    <span class="n">y_start_sub</span><span class="p">,</span> <span class="n">x_start_sub</span><span class="p">,</span> <span class="n">y_end_sub</span><span class="p">,</span> <span class="n">x_end_sub</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sub_image_size</span><span class="p">,</span> <span class="n">sub_image_size</span>

    <span class="c"># Here is a little tricky, please refer to image_misc.split_image</span>
    <span class="c"># Note, there are two images. One is the cropped sub image and the old image which the subimage cropped from</span>
    <span class="k">if</span> <span class="n">y_start_old</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y_start_sub</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">y_start_old</span>
        <span class="n">y_start_old</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">x_start_old</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x_start_sub</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">x_start_old</span>
        <span class="n">x_start_old</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">y_end_old</span> <span class="n">padded_square_size</span><span class="p">:</span>
        <span class="n">y_end_sub</span> <span class="o">=</span> <span class="n">sub_image_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_end_old</span> <span class="o">-</span> <span class="n">padded_square_size</span><span class="p">)</span>
        <span class="n">y_end_old</span> <span class="o">=</span> <span class="n">padded_square_size</span>

    <span class="k">if</span> <span class="n">x_end_old</span> <span class="n">padded_square_size</span><span class="p">:</span>
        <span class="n">x_end_sub</span> <span class="o">=</span> <span class="n">sub_image_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">x_end_old</span> <span class="o">-</span> <span class="n">padded_square_size</span><span class="p">)</span>
        <span class="n">x_end_old</span> <span class="o">=</span> <span class="n">padded_square_size</span>

    <span class="n">padded_heatmap</span><span class="p">[</span><span class="n">y_start_old</span><span class="p">:</span><span class="n">y_end_old</span><span class="p">,</span> <span class="n">x_start_old</span><span class="p">:</span><span class="n">x_end_old</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sub_heatmap_image</span><span class="p">[</span><span class="n">y_start_sub</span><span class="p">:</span><span class="n">y_end_sub</span><span class="p">,</span> <span class="n">x_start_sub</span><span class="p">:</span><span class="n">x_end_sub</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">padded_heatmap</span></code></pre></figure>


  </article>

  <!-- mathjax -->
  
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
  
  <!-- disqus comments -->
 
 <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'houxianxu'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
  
</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <!-- <h2 class="footer-heading">Xianxu Hou's blog</h2> -->

    <div class="footer-col-1 column">
      <ul>
        <li>Xianxu Hou's blog</li>
        <!-- <li><a href="mailto:"></a></li> -->
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/houxianxu">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">houxianxu</span>
          </a>
        </li>
        
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">From Coal Mining to Data Mining</p>
    </div>

  </div>

</footer>


    </body>
</html>